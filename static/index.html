<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Bot - Trading Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">ðŸ“ˆ</div>
            <span>Demo Bot</span>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="symbol">SÃ­mbolo</label>
                <select id="symbol">
                    <option value="DIA">DIA (Dow Jones ETF)</option>
                    <option value="SPY">SPY (S&P 500 ETF)</option>
                    <option value="QQQ">QQQ (Nasdaq ETF)</option>
                    <option value="BTC/USD">BTC/USD</option>
                    <option value="ETH/USD">ETH/USD</option>
                    <option value="AAPL">AAPL</option>
                    <option value="GOOGL">GOOGL</option>
                    <option value="MSFT">MSFT</option>
                    <option value="TSLA">TSLA</option>
                    <option value="NVDA">NVDA</option>
                    <option value="EUR/USD">EUR/USD</option>
                    <option value="GBP/USD">GBP/USD</option>
                    <option value="XAU/USD">XAU/USD (Ouro)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="timeframe">Timeframe</label>
                <select id="timeframe">
                    <option value="1min">1 min</option>
                    <option value="5min">5 min</option>
                    <option value="15min">15 min</option>
                    <option value="30min">30 min</option>
                    <option value="45min">45 min</option>
                    <option value="1h">1 hora</option>
                    <option value="2h">2 horas</option>
                    <option value="4h">4 horas</option>
                    <option value="1day">1 dia</option>
                    <option value="1week">1 semana</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="count">Candles</label>
                <input type="number" id="count" value="5000" min="10" style="width: 80px;">
            </div>
            
            <button class="btn" id="refreshBtn">Atualizar</button>
            <button class="btn btn-secondary" id="autoUpdateBtn">Auto: ON</button>
        </div>
        
        <div class="price-display">
            <span class="current-price" id="currentPrice">--</span>
            <span class="price-change" id="priceChange">--%</span>
        </div>
        
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Conectado</span>
        </div>
    </header>
    
    <main class="chart-container">
        <div id="chart"></div>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <span>Carregando dados...</span>
        </div>
    </main>
    
    <footer class="footer">
        <div class="footer-info">
            <div class="info-item">
                <span class="info-label">Open:</span>
                <span class="info-value" id="infoOpen">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">High:</span>
                <span class="info-value" id="infoHigh">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Low:</span>
                <span class="info-value" id="infoLow">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Close:</span>
                <span class="info-value" id="infoClose">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Volume:</span>
                <span class="info-value" id="infoVolume">--</span>
            </div>
        </div>
        <div class="footer-info">
            <span>Dados: Twelve Data API</span>
            <span>â€¢</span>
            <span id="lastUpdate">Ãšltima atualizaÃ§Ã£o: --</span>
        </div>
    </footer>
    
    <div class="error-toast" id="errorToast"></div>
    
    <script>
        // Chart setup
        const chartContainer = document.getElementById('chart');
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                background: { type: 'solid', color: '#0d1117' },
                textColor: '#8b949e',
                fontFamily: "'JetBrains Mono', monospace",
            },
            grid: {
                vertLines: { color: '#21262d' },
                horzLines: { color: '#21262d' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
                vertLine: {
                    color: '#58a6ff',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                    labelBackgroundColor: '#58a6ff',
                },
                horzLine: {
                    color: '#58a6ff',
                    width: 1,
                    style: LightweightCharts.LineStyle.Dashed,
                    labelBackgroundColor: '#58a6ff',
                },
            },
            rightPriceScale: {
                borderColor: '#30363d',
                scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
                borderColor: '#30363d',
                timeVisible: true,
                secondsVisible: false,
            },
            handleScale: {
                axisPressedMouseMove: { time: true, price: true },
            },
        });
        
        const candlestickSeries = chart.addCandlestickSeries({
            upColor: '#3fb950',
            downColor: '#f85149',
            borderUpColor: '#3fb950',
            borderDownColor: '#f85149',
            wickUpColor: '#3fb950',
            wickDownColor: '#f85149',
        });
        
        // Volume series (only shown for assets with volume data)
        const volumeSeries = chart.addHistogramSeries({
            color: '#58a6ff',
            priceFormat: { type: 'volume' },
            priceScaleId: 'volume',
        });
        volumeSeries.priceScale().applyOptions({
            scaleMargins: { top: 0.85, bottom: 0 },
        });
        
        // Resize handler
        function handleResize() {
            chart.applyOptions({
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
            });
        }
        window.addEventListener('resize', handleResize);
        handleResize();
        
        // State
        let autoUpdate = true;
        let updateInterval = null;
        let currentData = [];
        
        // DOM elements
        const symbolSelect = document.getElementById('symbol');
        const timeframeSelect = document.getElementById('timeframe');
        const countInput = document.getElementById('count');
        const refreshBtn = document.getElementById('refreshBtn');
        const autoUpdateBtn = document.getElementById('autoUpdateBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorToast = document.getElementById('errorToast');
        const currentPriceEl = document.getElementById('currentPrice');
        const priceChangeEl = document.getElementById('priceChange');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        // Fetch candles from API
        async function fetchCandles() {
            const symbol = symbolSelect.value;
            const timeframe = timeframeSelect.value;
            const count = parseInt(countInput.value);
            
            showLoading(true);
            
            try {
                const url = `/api/candles?symbol=${encodeURIComponent(symbol)}&timeframe=${timeframe}&count=${count}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erro ao buscar dados');
                }
                
                const data = await response.json();
                currentData = data;
                
                // Update chart
                candlestickSeries.setData(data);
                
                // Update volume only if there's volume data (not crypto)
                const hasVolume = data.some(d => d.volume > 0);
                if (hasVolume) {
                    const volumeData = data.map(d => ({
                        time: d.time,
                        value: d.volume,
                        color: d.close >= d.open ? 'rgba(63, 185, 80, 0.4)' : 'rgba(248, 81, 73, 0.4)',
                    }));
                    volumeSeries.setData(volumeData);
                } else {
                    volumeSeries.setData([]);
                }
                
                // Fit content
                chart.timeScale().fitContent();
                
                // Update price display
                if (data.length > 0) {
                    const latest = data[data.length - 1];
                    const first = data[0];
                    updatePriceDisplay(latest, first);
                }
                
                // Update status
                setStatus('connected', 'Conectado');
                updateLastUpdateTime();
                
            } catch (error) {
                console.error('Fetch error:', error);
                showError(error.message);
                setStatus('error', 'Erro');
            } finally {
                showLoading(false);
            }
        }
        
        // Update price display
        function updatePriceDisplay(latest, first) {
            const price = latest.close;
            const change = ((latest.close - first.open) / first.open) * 100;
            
            currentPriceEl.textContent = formatPrice(price);
            
            priceChangeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            priceChangeEl.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
        }
        
        // Format price
        function formatPrice(price) {
            if (price >= 1000) {
                return price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else if (price >= 1) {
                return price.toFixed(4);
            } else {
                return price.toFixed(6);
            }
        }
        
        // Show/hide loading
        function showLoading(show) {
            loadingOverlay.classList.toggle('active', show);
        }
        
        // Show error toast
        function showError(message) {
            errorToast.textContent = message;
            errorToast.classList.add('show');
            setTimeout(() => errorToast.classList.remove('show'), 5000);
        }
        
        // Set connection status
        function setStatus(status, text) {
            statusDot.style.background = status === 'connected' ? '#3fb950' : '#f85149';
            statusDot.style.animation = status === 'connected' ? 'pulse 2s infinite' : 'none';
            statusText.textContent = text;
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Ãšltima atualizaÃ§Ã£o: ${now.toLocaleTimeString('pt-BR')}`;
        }
        
        // Toggle auto update
        function toggleAutoUpdate() {
            autoUpdate = !autoUpdate;
            autoUpdateBtn.textContent = `Auto: ${autoUpdate ? 'ON' : 'OFF'}`;
            
            if (autoUpdate) {
                startAutoUpdate();
            } else {
                stopAutoUpdate();
            }
        }
        
        // Start auto update interval
        function startAutoUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(fetchCandles, 60000); // 60 seconds
        }
        
        // Stop auto update
        function stopAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }
        
        // Crosshair move handler for footer info
        chart.subscribeCrosshairMove(param => {
            if (param.time && param.seriesData.size > 0) {
                const data = param.seriesData.get(candlestickSeries);
                if (data) {
                    document.getElementById('infoOpen').textContent = formatPrice(data.open);
                    document.getElementById('infoHigh').textContent = formatPrice(data.high);
                    document.getElementById('infoLow').textContent = formatPrice(data.low);
                    document.getElementById('infoClose').textContent = formatPrice(data.close);
                    
                    const volumeData = param.seriesData.get(volumeSeries);
                    if (volumeData) {
                        document.getElementById('infoVolume').textContent = volumeData.value.toLocaleString();
                    }
                }
            }
        });
        
        // Event listeners
        refreshBtn.addEventListener('click', fetchCandles);
        autoUpdateBtn.addEventListener('click', toggleAutoUpdate);
        symbolSelect.addEventListener('change', fetchCandles);
        timeframeSelect.addEventListener('change', fetchCandles);
        countInput.addEventListener('change', fetchCandles);
        
        // Initial load
        fetchCandles();
        startAutoUpdate();
    </script>
</body>
</html>

